# AI测试用例生成系统 - 开发者文档

## 目录

- [开发环境搭建](#开发环境搭建)
- [项目结构](#项目结构)
- [核心模块](#核心模块)
- [API开发](#api开发)
- [数据库设计](#数据库设计)
- [测试指南](#测试指南)
- [部署指南](#部署指南)

## 开发环境搭建

### 环境要求

- Python 3.10+
- Node.js 18+
- PostgreSQL 14+
- Redis 6+
- Git

### 后端开发环境

#### 1. 克隆代码

```bash
git clone <repository-url>
cd AITest4All
```

#### 2. 创建虚拟环境

```bash
cd backend
python -m venv venv

# Windows
venv\Scripts\activate

# Linux/Mac
source venv/bin/activate
```

#### 3. 安装依赖

```bash
pip install -r requirements.txt
```

#### 4. 配置环境变量

复制环境变量示例文件：

```bash
copy .env.example .env
```

编辑 `.env` 文件，配置以下关键参数：

```bash
# 数据库配置
DATABASE_URL=postgresql://postgres:password@localhost:5432/ai_test_case_generator
REDIS_URL=redis://localhost:6379/0

# LLM配置
OPENAI_API_KEY=your_openai_api_key
ANTHROPIC_API_KEY=your_anthropic_api_key
DEFAULT_MODEL_PROVIDER=openai
DEFAULT_MODEL_NAME=gpt-4
DEFAULT_TEMPERATURE=0.7
DEFAULT_MAX_TOKENS=2000

# 应用配置
APP_ENV=development
APP_HOST=0.0.0.0
APP_PORT=8000
```

#### 5. 初始化数据库

```bash
# 创建数据库
createdb ai_test_case_generator

# 运行数据库迁移
alembic upgrade head
```

#### 6. 启动开发服务器

```bash
uvicorn app.main:app --reload --host 0.0.0.0 --port 8000
```

访问 http://localhost:8000/docs 查看API文档

### 前端开发环境

#### 1. 安装依赖

```bash
cd frontend
npm install
```

#### 2. 配置环境变量

复制环境变量示例文件：

```bash
copy .env.example .env
```

编辑 `.env` 文件：

```bash
VITE_API_BASE_URL=http://localhost:8000
VITE_WS_BASE_URL=ws://localhost:8000
```

#### 3. 启动开发服务器

```bash
npm run dev
```

访问 http://localhost:5173

### 开发工具推荐

- **IDE**: VS Code / PyCharm / WebStorm
- **API测试**: Postman / Insomnia
- **数据库管理**: DBeaver / pgAdmin
- **Redis管理**: RedisInsight
- **Git客户端**: SourceTree / GitKraken

### VS Code 推荐插件

- Python
- Pylance
- ESLint
- Prettier
- GitLens
- Thunder Client
- Database Client

## 项目结构

### 后端结构

```
backend/
├── app/
│   ├── __init__.py
│   ├── main.py                 # FastAPI应用入口
│   ├── core/                   # 核心配置
│   │   ├── config.py          # 配置管理
│   │   ├── database.py        # 数据库连接
│   │   ├── redis_client.py    # Redis客户端
│   │   ├── security.py        # 安全相关
│   │   ├── cache.py           # 缓存管理
│   │   ├── exceptions.py      # 自定义异常
│   │   └── error_handlers.py  # 错误处理
│   ├── models/                 # 数据库模型
│   │   ├── __init__.py
│   │   ├── agent_config.py    # Agent配置模型
│   │   ├── knowledge_base.py  # 知识库模型
│   │   ├── python_script.py   # Python脚本模型
│   │   ├── case_template.py   # 用例模板模型
│   │   ├── test_case.py       # 测试用例模型
│   │   └── agent_execution.py # Agent执行记录
│   ├── schemas/                # Pydantic模型
│   │   ├── __init__.py
│   │   └── generate.py        # 生成相关Schema
│   ├── api/                    # API路由
│   │   ├── __init__.py
│   │   ├── generate.py        # 用例生成API
│   │   ├── websocket.py       # WebSocket API
│   │   ├── knowledge_base.py  # 知识库API
│   │   ├── scripts.py         # 脚本管理API
│   │   ├── templates.py       # 模板管理API
│   │   ├── agent_configs.py   # Agent配置API
│   │   ├── model_config.py    # 模型配置API
│   │   ├── prompts.py         # 提示词管理API
│   │   ├── export.py          # 导出API
│   │   └── feedback.py        # 反馈API
│   ├── services/               # 业务逻辑
│   │   ├── __init__.py
│   │   ├── session_manager.py # 会话管理
│   │   ├── knowledge_base.py  # 知识库服务
│   │   ├── script_executor.py # 脚本执行服务
│   │   ├── document_parser.py # 文档解析服务
│   │   └── prompt_manager.py  # 提示词管理服务
│   ├── agents/                 # AI Agents
│   │   ├── __init__.py
│   │   ├── base_agent.py      # Agent基类
│   │   ├── requirement_agent.py # 需求分析Agent
│   │   ├── scenario_agent.py  # 场景生成Agent
│   │   ├── case_agent.py      # 用例生成Agent
│   │   ├── code_agent.py      # 代码生成Agent
│   │   ├── quality_agent.py   # 质量优化Agent
│   │   ├── optimize_agent.py  # 优化Agent
│   │   └── factory.py         # Agent工厂
│   ├── tools/                  # 工具模块
│   │   ├── __init__.py
│   │   ├── base.py            # 工具基类
│   │   ├── document_parser.py # 文档解析工具
│   │   ├── knowledge_base.py  # 知识库工具
│   │   └── script_executor.py # 脚本执行工具
│   └── mcp/                    # MCP服务器
│       ├── __init__.py
│       └── server.py          # MCP服务器实现
├── alembic/                    # 数据库迁移
│   ├── versions/              # 迁移版本
│   └── env.py                 # Alembic配置
├── tests/                      # 测试文件
│   ├── test_agents.py
│   ├── test_api.py
│   └── test_services.py
├── agent_prompts/              # Agent提示词
│   ├── requirement_agent.txt
│   ├── scenario_agent.txt
│   ├── case_agent.txt
│   ├── code_agent.txt
│   ├── quality_agent.txt
│   └── optimize_agent.txt
├── scripts/                    # 工具脚本
│   ├── verify_db.py
│   └── test_model_config.py
├── requirements.txt            # Python依赖
├── alembic.ini                # Alembic配置
├── .env.example               # 环境变量示例
└── Dockerfile                 # Docker配置
```

### 前端结构

```
frontend/
├── src/
│   ├── main.tsx               # 应用入口
│   ├── App.tsx                # 根组件
│   ├── api/                   # API客户端
│   │   ├── index.ts          # API配置
│   │   ├── generate.ts       # 生成API
│   │   └── knowledgeBase.ts  # 知识库API
│   ├── components/            # 通用组件
│   │   ├── Layout/           # 布局组件
│   │   │   └── MainLayout.tsx
│   │   ├── Generate/         # 生成相关组件
│   │   │   ├── RequirementInput.tsx
│   │   │   ├── RequirementAnalysisResult.tsx
│   │   │   ├── ScenarioList.tsx
│   │   │   ├── TestCaseList.tsx
│   │   │   ├── CodeGeneration.tsx
│   │   │   ├── QualityReport.tsx
│   │   │   ├── ExportPanel.tsx
│   │   │   └── StreamingOutput.tsx
│   │   └── ErrorBoundary.tsx # 错误边界
│   ├── pages/                 # 页面组件
│   │   ├── Home.tsx          # 首页
│   │   ├── Generate.tsx      # 用例生成页
│   │   ├── KnowledgeBase.tsx # 知识库管理页
│   │   ├── Scripts.tsx       # 脚本管理页
│   │   ├── Templates.tsx     # 模板管理页
│   │   └── Settings.tsx      # 设置页
│   ├── stores/                # 状态管理
│   │   └── useGenerationStore.ts
│   ├── types/                 # 类型定义
│   │   └── index.ts
│   ├── utils/                 # 工具函数
│   │   ├── errorHandler.ts   # 错误处理
│   │   └── fileUpload.ts     # 文件上传
│   └── styles/                # 样式文件
│       └── global.css
├── public/                    # 静态资源
├── index.html                 # HTML模板
├── package.json               # 前端依赖
├── tsconfig.json             # TypeScript配置
├── vite.config.ts            # Vite配置
└── .env.example              # 环境变量示例
```

## 核心模块

### 1. Agent系统

#### Agent基类

所有Agent继承自`BaseAgent`类：

```python
# backend/app/agents/base_agent.py
from abc import ABC, abstractmethod
from typing import Dict, Any, Optional
from openai import AsyncOpenAI
from anthropic import AsyncAnthropic

class BaseAgent(ABC):
    def __init__(
        self,
        model_provider: str = "openai",
        model_name: str = "gpt-4",
        temperature: float = 0.7,
        max_tokens: int = 2000
    ):
        self.model_provider = model_provider
        self.model_name = model_name
        self.temperature = temperature
        self.max_tokens = max_tokens
        self._init_client()
    
    def _init_client(self):
        """初始化LLM客户端"""
        if self.model_provider == "openai":
            self.client = AsyncOpenAI()
        elif self.model_provider == "anthropic":
            self.client = AsyncAnthropic()
    
    @abstractmethod
    async def run(self, input_data: Dict[str, Any]) -> Dict[str, Any]:
        """执行Agent任务"""
        pass
    
    @abstractmethod
    def get_prompt(self, input_data: Dict[str, Any]) -> str:
        """获取提示词"""
        pass
    
    async def call_llm(self, prompt: str) -> str:
        """调用LLM"""
        if self.model_provider == "openai":
            response = await self.client.chat.completions.create(
                model=self.model_name,
                messages=[{"role": "user", "content": prompt}],
                temperature=self.temperature,
                max_tokens=self.max_tokens
            )
            return response.choices[0].message.content
        elif self.model_provider == "anthropic":
            response = await self.client.messages.create(
                model=self.model_name,
                messages=[{"role": "user", "content": prompt}],
                temperature=self.temperature,
                max_tokens=self.max_tokens
            )
            return response.content[0].text
```

#### 需求分析Agent

```python
# backend/app/agents/requirement_agent.py
from .base_agent import BaseAgent
from typing import Dict, Any

class RequirementAgent(BaseAgent):
    async def run(self, input_data: Dict[str, Any]) -> Dict[str, Any]:
        """分析需求文档"""
        prompt = self.get_prompt(input_data)
        result = await self.call_llm(prompt)
        return self._parse_result(result)
    
    def get_prompt(self, input_data: Dict[str, Any]) -> str:
        """获取需求分析提示词"""
        requirement_text = input_data.get("requirement_text", "")
        knowledge_base = input_data.get("knowledge_base", "")
        
        # 从文件加载提示词模板
        with open("agent_prompts/requirement_agent.txt", "r", encoding="utf-8") as f:
            template = f.read()
        
        # 替换变量
        prompt = template.format(
            requirement_text=requirement_text,
            knowledge_base=knowledge_base
        )
        return prompt
    
    def _parse_result(self, result: str) -> Dict[str, Any]:
        """解析LLM返回结果"""
        import json
        try:
            return json.loads(result)
        except:
            return {"raw_result": result}
```

### 2. 数据库模型

#### Agent配置模型

```python
# backend/app/models/agent_config.py
from sqlalchemy import Column, Integer, String, Text, JSON, Boolean, DateTime
from sqlalchemy.sql import func
from app.core.database import Base

class AgentConfig(Base):
    __tablename__ = "agent_configs"
    
    id = Column(Integer, primary_key=True, index=True)
    agent_type = Column(String(50), nullable=False)  # requirement/scenario/case/code/quality
    agent_name = Column(String(100), nullable=False)
    model_provider = Column(String(50), default="openai")
    model_name = Column(String(100), default="gpt-4")
    prompt_template = Column(Text)
    model_params = Column(JSON)  # {"temperature": 0.7, "max_tokens": 2000}
    knowledge_bases = Column(JSON)  # [1, 2, 3]
    scripts = Column(JSON)  # [1, 2, 3]
    is_default = Column(Boolean, default=False)
    created_at = Column(DateTime(timezone=True), server_default=func.now())
    updated_at = Column(DateTime(timezone=True), onupdate=func.now())
```

#### 知识库模型

```python
# backend/app/models/knowledge_base.py
from sqlalchemy import Column, Integer, String, Text, JSON, DateTime
from sqlalchemy.sql import func
from app.core.database import Base

class KnowledgeBase(Base):
    __tablename__ = "knowledge_bases"
    
    id = Column(Integer, primary_key=True, index=True)
    name = Column(String(200), nullable=False)
    type = Column(String(50))  # case/defect/rule/api
    storage_type = Column(String(50))  # local/url/database
    file_path = Column(String(500))
    url = Column(String(500))
    content = Column(Text)
    metadata = Column(JSON)
    vector_index = Column(String(100))
    created_at = Column(DateTime(timezone=True), server_default=func.now())
    updated_at = Column(DateTime(timezone=True), onupdate=func.now())
```

### 3. API路由

#### 用例生成API

```python
# backend/app/api/generate.py
from fastapi import APIRouter, Depends, HTTPException
from sqlalchemy.ext.asyncio import AsyncSession
from app.core.database import get_db
from app.schemas.generate import GenerateRequest, GenerateResponse
from app.agents.factory import AgentFactory

router = APIRouter(prefix="/generate", tags=["generate"])

@router.post("/requirement", response_model=GenerateResponse)
async def analyze_requirement(
    request: GenerateRequest,
    db: AsyncSession = Depends(get_db)
):
    """需求分析"""
    try:
        # 创建需求分析Agent
        agent = AgentFactory.create_agent("requirement")
        
        # 执行分析
        result = await agent.run({
            "requirement_text": request.requirement_text,
            "knowledge_base": request.knowledge_base
        })
        
        return GenerateResponse(
            success=True,
            data=result
        )
    except Exception as e:
        raise HTTPException(status_code=500, detail=str(e))

@router.post("/scenario", response_model=GenerateResponse)
async def generate_scenario(
    request: GenerateRequest,
    db: AsyncSession = Depends(get_db)
):
    """场景生成"""
    try:
        agent = AgentFactory.create_agent("scenario")
        result = await agent.run({
            "requirement_analysis": request.requirement_analysis,
            "test_type": request.test_type
        })
        return GenerateResponse(success=True, data=result)
    except Exception as e:
        raise HTTPException(status_code=500, detail=str(e))
```

### 4. 服务层

#### 会话管理服务

```python
# backend/app/services/session_manager.py
from typing import Dict, Any, Optional
import json
from app.core.redis_client import get_redis_client

class SessionManager:
    def __init__(self):
        self.redis = get_redis_client()
        self.expire_time = 86400  # 24小时
    
    async def create_session(self, session_id: str) -> None:
        """创建会话"""
        await self.redis.setex(
            f"session:{session_id}",
            self.expire_time,
            json.dumps({})
        )
    
    async def save_result(
        self,
        session_id: str,
        key: str,
        data: Dict[str, Any]
    ) -> None:
        """保存Agent结果"""
        await self.redis.setex(
            f"session:{session_id}:{key}",
            self.expire_time,
            json.dumps(data)
        )
    
    async def get_result(
        self,
        session_id: str,
        key: str
    ) -> Optional[Dict[str, Any]]:
        """获取Agent结果"""
        data = await self.redis.get(f"session:{session_id}:{key}")
        if data:
            return json.loads(data)
        return None
    
    async def delete_session(self, session_id: str) -> None:
        """删除会话"""
        keys = await self.redis.keys(f"session:{session_id}*")
        if keys:
            await self.redis.delete(*keys)
```

### 5. WebSocket实时通信

```python
# backend/app/api/websocket.py
from fastapi import APIRouter, WebSocket, WebSocketDisconnect
from app.agents.factory import AgentFactory
import json

router = APIRouter()

@router.websocket("/ws/{session_id}")
async def websocket_generate(websocket: WebSocket, session_id: str):
    """WebSocket实时生成"""
    await websocket.accept()
    
    try:
        # 接收请求
        data = await websocket.receive_json()
        agent_type = data.get("agent_type")
        input_data = data.get("input_data")
        
        # 创建Agent
        agent = AgentFactory.create_agent(agent_type)
        
        # 流式生成
        async for chunk in agent.stream(input_data):
            await websocket.send_json({
                "type": "chunk",
                "content": chunk
            })
        
        # 完成
        await websocket.send_json({
            "type": "done"
        })
    
    except WebSocketDisconnect:
        print(f"Client disconnected: {session_id}")
    except Exception as e:
        await websocket.send_json({
            "type": "error",
            "message": str(e)
        })
```

## API开发

### API规范

#### 请求格式

所有POST请求使用JSON格式：

```json
{
  "requirement_text": "用户登录功能需求",
  "test_type": "ui",
  "knowledge_base": ["历史用例库", "缺陷库"]
}
```

#### 响应格式

统一的响应格式：

```json
{
  "success": true,
  "data": {
    // 具体数据
  },
  "message": "操作成功",
  "code": 200
}
```

错误响应：

```json
{
  "success": false,
  "data": null,
  "message": "错误信息",
  "code": 500
}
```

### 添加新的API端点

1. 在`app/api/`目录下创建新的路由文件
2. 定义路由和处理函数
3. 在`app/api/__init__.py`中注册路由
4. 在`app/main.py`中包含路由

示例：

```python
# app/api/my_feature.py
from fastapi import APIRouter, Depends
from sqlalchemy.ext.asyncio import AsyncSession
from app.core.database import get_db

router = APIRouter(prefix="/my-feature", tags=["my-feature"])

@router.get("/")
async def get_my_feature(db: AsyncSession = Depends(get_db)):
    return {"message": "My Feature"}

# app/api/__init__.py
from .my_feature import router as my_feature_router

# app/main.py
from app.api import my_feature_router
app.include_router(my_feature_router)
```

### API文档

FastAPI自动生成API文档：

- Swagger UI: http://localhost:8000/docs
- ReDoc: http://localhost:8000/redoc

## 数据库设计

### 数据库迁移

使用Alembic管理数据库迁移：

#### 创建迁移

```bash
# 自动生成迁移文件
alembic revision --autogenerate -m "描述"

# 手动创建迁移文件
alembic revision -m "描述"
```

#### 应用迁移

```bash
# 升级到最新版本
alembic upgrade head

# 升级到指定版本
alembic upgrade <revision>

# 回滚一个版本
alembic downgrade -1
```

#### 查看迁移历史

```bash
alembic history
alembic current
```

### 数据库查询

使用SQLAlchemy进行数据库操作：

```python
from sqlalchemy import select
from app.models.agent_config import AgentConfig

# 查询
async def get_agent_config(db: AsyncSession, agent_type: str):
    result = await db.execute(
        select(AgentConfig).where(AgentConfig.agent_type == agent_type)
    )
    return result.scalars().first()

# 创建
async def create_agent_config(db: AsyncSession, config_data: dict):
    config = AgentConfig(**config_data)
    db.add(config)
    await db.commit()
    await db.refresh(config)
    return config

# 更新
async def update_agent_config(db: AsyncSession, config_id: int, update_data: dict):
    result = await db.execute(
        select(AgentConfig).where(AgentConfig.id == config_id)
    )
    config = result.scalars().first()
    if config:
        for key, value in update_data.items():
            setattr(config, key, value)
        await db.commit()
        await db.refresh(config)
    return config

# 删除
async def delete_agent_config(db: AsyncSession, config_id: int):
    result = await db.execute(
        select(AgentConfig).where(AgentConfig.id == config_id)
    )
    config = result.scalars().first()
    if config:
        await db.delete(config)
        await db.commit()
    return config
```

## 测试指南

### 单元测试

使用pytest进行单元测试：

```python
# tests/test_agents.py
import pytest
from app.agents.requirement_agent import RequirementAgent

@pytest.mark.asyncio
async def test_requirement_agent():
    agent = RequirementAgent()
    result = await agent.run({
        "requirement_text": "用户登录功能",
        "knowledge_base": ""
    })
    assert result is not None
    assert "功能点" in result
```

运行测试：

```bash
# 运行所有测试
pytest

# 运行特定测试文件
pytest tests/test_agents.py

# 运行特定测试函数
pytest tests/test_agents.py::test_requirement_agent

# 生成覆盖率报告
pytest --cov=app --cov-report=html
```

### API测试

```python
# tests/test_api.py
from fastapi.testclient import TestClient
from app.main import app

client = TestClient(app)

def test_analyze_requirement():
    response = client.post(
        "/generate/requirement",
        json={
            "requirement_text": "用户登录功能",
            "test_type": "ui"
        }
    )
    assert response.status_code == 200
    assert response.json()["success"] is True
```

### 集成测试

```python
# tests/test_integration.py
import pytest
from app.agents.factory import AgentFactory

@pytest.mark.asyncio
async def test_full_pipeline():
    # 需求分析
    requirement_agent = AgentFactory.create_agent("requirement")
    requirement_result = await requirement_agent.run({
        "requirement_text": "用户登录功能"
    })
    
    # 场景生成
    scenario_agent = AgentFactory.create_agent("scenario")
    scenario_result = await scenario_agent.run({
        "requirement_analysis": requirement_result
    })
    
    # 用例生成
    case_agent = AgentFactory.create_agent("case")
    case_result = await case_agent.run({
        "scenarios": scenario_result
    })
    
    assert case_result is not None
```

## 部署指南

### 开发环境部署

参考[开发环境搭建](#开发环境搭建)

### 生产环境部署

详见[部署运维文档](./部署运维文档.md)

### Docker部署

```bash
# 构建镜像
docker-compose build

# 启动服务
docker-compose up -d

# 查看日志
docker-compose logs -f

# 停止服务
docker-compose down
```

## 代码规范

### Python代码规范

遵循PEP 8规范：

- 使用4个空格缩进
- 行长度不超过120字符
- 使用类型注解
- 添加文档字符串

```python
from typing import Dict, Any, Optional

async def process_data(
    data: Dict[str, Any],
    option: Optional[str] = None
) -> Dict[str, Any]:
    """
    处理数据
    
    Args:
        data: 输入数据
        option: 可选参数
    
    Returns:
        处理后的数据
    """
    # 实现逻辑
    return result
```

### TypeScript代码规范

遵循ESLint配置：

- 使用2个空格缩进
- 使用单引号
- 使用分号
- 使用类型注解

```typescript
interface UserData {
  id: number;
  name: string;
  email?: string;
}

const processUser = async (user: UserData): Promise<void> => {
  // 实现逻辑
};
```

### Git提交规范

遵循Conventional Commits规范：

```
<type>(<scope>): <subject>

<body>

<footer>
```

类型：
- feat: 新功能
- fix: 修复bug
- docs: 文档更新
- style: 代码格式
- refactor: 重构
- test: 测试
- chore: 构建/工具

示例：

```
feat(agent): 添加需求分析Agent

- 实现需求文档解析
- 添加知识库检索
- 生成分析报告

Closes #123
```

## 常见问题

### Q: 如何添加新的Agent？

A: 步骤：
1. 在`app/agents/`创建新的Agent类，继承`BaseAgent`
2. 实现`run()`和`get_prompt()`方法
3. 在`agent_prompts/`添加提示词文件
4. 在`AgentFactory`中注册新Agent
5. 添加对应的API端点

### Q: 如何调试Agent？

A: 方法：
1. 使用日志记录Agent的输入输出
2. 在开发环境中使用`--reload`模式
3. 使用Postman测试API
4. 查看LLM的原始响应

### Q: 如何优化性能？

A: 建议：
1. 使用Redis缓存频繁查询的数据
2. 使用异步IO提高并发性能
3. 优化数据库查询，添加索引
4. 使用连接池管理数据库连接
5. 压缩提示词，减少Token消耗

### Q: 如何处理错误？

A: 策略：
1. 使用自定义异常类
2. 在API层捕获并处理异常
3. 返回统一的错误响应格式
4. 记录错误日志
5. 对用户友好的错误提示

---

更多信息请参考[用户指南](./用户指南.md)和[部署运维文档](./部署运维文档.md)。
