# AI测试用例生成系统 - 部署运维文档

## 目录

- [部署概述](#部署概述)
- [环境准备](#环境准备)
- [Docker部署](#docker部署)
- [手动部署](#手动部署)
- [Nginx配置](#nginx配置)
- [进程管理](#进程管理)
- [数据库管理](#数据库管理)
- [监控告警](#监控告警)
- [备份恢复](#备份恢复)
- [性能优化](#性能优化)
- [故障排查](#故障排查)
- [安全加固](#安全加固)

## 部署概述

### 部署架构

```
                    ┌─────────────┐
                    │   Nginx     │
                    │  (反向代理)  │
                    └──────┬──────┘
                           │
              ┌────────────┴────────────┐
              │                         │
        ┌─────▼─────┐            ┌─────▼─────┐
        │  前端应用  │            │  后端API   │
        │  (React)  │            │ (FastAPI)  │
        └───────────┘            └─────┬──────┘
                                       │
                    ┌──────────────────┼──────────────────┐
                    │                  │                  │
              ┌─────▼─────┐      ┌────▼────┐      ┌─────▼─────┐
              │PostgreSQL │      │  Redis  │      │    LLM    │
              │  (数据库)  │      │ (缓存)  │      │   API     │
              └───────────┘      └─────────┘      └───────────┘
```

### 服务器要求

**最低配置**:
- CPU: 4核
- 内存: 4GB
- 磁盘: 40GB
- 操作系统: Ubuntu 20.04 / CentOS 7+

**推荐配置**:
- CPU: 8核
- 内存: 8GB
- 磁盘: 100GB SSD
- 操作系统: Ubuntu 22.04

## 环境准备

### 1. 系统更新

```bash
# Ubuntu/Debian
sudo apt update
sudo apt upgrade -y

# CentOS/RHEL
sudo yum update -y
```

### 2. 安装基础软件

```bash
# Ubuntu/Debian
sudo apt install -y git curl wget vim build-essential

# CentOS/RHEL
sudo yum install -y git curl wget vim gcc gcc-c++ make
```

### 3. 安装Python 3.10+

```bash
# Ubuntu 22.04 (自带Python 3.10)
sudo apt install -y python3 python3-pip python3-venv

# Ubuntu 20.04 (需要添加PPA)
sudo add-apt-repository ppa:deadsnakes/ppa
sudo apt update
sudo apt install -y python3.10 python3.10-venv python3.10-dev
```

### 4. 安装Node.js 18+

```bash
# 使用NodeSource仓库
curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
sudo apt install -y nodejs

# 验证安装
node --version
npm --version
```

### 5. 安装PostgreSQL 14+

```bash
# Ubuntu/Debian
sudo apt install -y postgresql postgresql-contrib

# 启动服务
sudo systemctl start postgresql
sudo systemctl enable postgresql

# 创建数据库和用户
sudo -u postgres psql
CREATE DATABASE ai_test_case_generator;
CREATE USER aitest WITH PASSWORD 'your_password';
GRANT ALL PRIVILEGES ON DATABASE ai_test_case_generator TO aitest;
\q
```

### 6. 安装Redis 6+

```bash
# Ubuntu/Debian
sudo apt install -y redis-server

# 启动服务
sudo systemctl start redis-server
sudo systemctl enable redis-server

# 验证安装
redis-cli ping
```

### 7. 安装Nginx

```bash
# Ubuntu/Debian
sudo apt install -y nginx

# 启动服务
sudo systemctl start nginx
sudo systemctl enable nginx
```

## Docker部署

### 1. 安装Docker

```bash
# 安装Docker
curl -fsSL https://get.docker.com | sh

# 启动Docker
sudo systemctl start docker
sudo systemctl enable docker

# 安装Docker Compose
sudo curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
sudo chmod +x /usr/local/bin/docker-compose

# 验证安装
docker --version
docker-compose --version
```

### 2. 配置环境变量

```bash
# 复制环境变量示例文件
cp .env.docker.example .env.docker

# 编辑环境变量
vim .env.docker
```

关键配置项:

```bash
# 数据库配置
POSTGRES_USER=aitest
POSTGRES_PASSWORD=your_secure_password
POSTGRES_DB=ai_test_case_generator

# Redis配置
REDIS_PASSWORD=your_redis_password

# LLM配置
OPENAI_API_KEY=your_openai_api_key
ANTHROPIC_API_KEY=your_anthropic_api_key

# 应用配置
APP_ENV=production
SECRET_KEY=your_secret_key
```

### 3. 启动服务

```bash
# 构建镜像
docker-compose build

# 启动所有服务
docker-compose up -d

# 查看服务状态
docker-compose ps

# 查看日志
docker-compose logs -f
```

### 4. 初始化数据库

```bash
# 进入后端容器
docker-compose exec backend bash

# 运行数据库迁移
alembic upgrade head

# 退出容器
exit
```

### 5. 访问应用

- 前端: http://your-server-ip:80
- 后端API: http://your-server-ip:8000
- API文档: http://your-server-ip:8000/docs

### 6. Docker常用命令

```bash
# 查看运行中的容器
docker-compose ps

# 查看日志
docker-compose logs -f [service_name]

# 重启服务
docker-compose restart [service_name]

# 停止服务
docker-compose stop

# 停止并删除容器
docker-compose down

# 停止并删除容器和数据卷
docker-compose down -v

# 进入容器
docker-compose exec [service_name] bash

# 查看资源使用
docker stats
```

## 手动部署

### 1. 克隆代码

```bash
cd /var/www
sudo git clone <repository-url> ai-test-case-generator
cd ai-test-case-generator
```

### 2. 部署后端

```bash
cd backend

# 创建虚拟环境
python3 -m venv venv
source venv/bin/activate

# 安装依赖
pip install -r requirements.txt

# 配置环境变量
cp .env.example .env
vim .env

# 初始化数据库
alembic upgrade head

# 测试启动
uvicorn app.main:app --host 0.0.0.0 --port 8000
```

### 3. 部署前端

```bash
cd ../frontend

# 安装依赖
npm install

# 配置环境变量
cp .env.example .env
vim .env

# 构建生产版本
npm run build

# 构建产物在 dist/ 目录
```

### 4. 配置系统服务

创建后端服务文件:

```bash
sudo vim /etc/systemd/system/ai-test-backend.service
```

内容:

```ini
[Unit]
Description=AI Test Case Generator Backend
After=network.target postgresql.service redis.service

[Service]
Type=simple
User=www-data
WorkingDirectory=/var/www/ai-test-case-generator/backend
Environment="PATH=/var/www/ai-test-case-generator/backend/venv/bin"
ExecStart=/var/www/ai-test-case-generator/backend/venv/bin/uvicorn app.main:app --host 0.0.0.0 --port 8000 --workers 4
Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target
```

启动服务:

```bash
sudo systemctl daemon-reload
sudo systemctl start ai-test-backend
sudo systemctl enable ai-test-backend
sudo systemctl status ai-test-backend
```

## Nginx配置

### 1. 创建Nginx配置文件

```bash
sudo vim /etc/nginx/sites-available/ai-test-case-generator
```

配置内容:

```nginx
# 后端API服务器
upstream backend {
    server 127.0.0.1:8000;
}

server {
    listen 80;
    server_name your-domain.com;
    
    # 前端静态文件
    location / {
        root /var/www/ai-test-case-generator/frontend/dist;
        try_files $uri $uri/ /index.html;
    }
    
    # 后端API
    location /api/ {
        proxy_pass http://backend/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
    
    # WebSocket
    location /ws/ {
        proxy_pass http://backend/ws/;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
    
    # 静态资源缓存
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
        root /var/www/ai-test-case-generator/frontend/dist;
        expires 1y;
        add_header Cache-Control "public, immutable";
    }
}
```

### 2. 启用配置

```bash
# 创建软链接
sudo ln -s /etc/nginx/sites-available/ai-test-case-generator /etc/nginx/sites-enabled/

# 测试配置
sudo nginx -t

# 重启Nginx
sudo systemctl restart nginx
```

### 3. 配置HTTPS (可选)

使用Let's Encrypt免费证书:

```bash
# 安装Certbot
sudo apt install -y certbot python3-certbot-nginx

# 获取证书
sudo certbot --nginx -d your-domain.com

# 自动续期
sudo certbot renew --dry-run
```

## 进程管理

### 使用Systemd

查看服务状态:

```bash
sudo systemctl status ai-test-backend
```

启动/停止/重启服务:

```bash
sudo systemctl start ai-test-backend
sudo systemctl stop ai-test-backend
sudo systemctl restart ai-test-backend
```

查看日志:

```bash
sudo journalctl -u ai-test-backend -f
```

### 使用Supervisor (可选)

安装Supervisor:

```bash
sudo apt install -y supervisor
```

配置文件:

```bash
sudo vim /etc/supervisor/conf.d/ai-test-backend.conf
```

内容:

```ini
[program:ai-test-backend]
command=/var/www/ai-test-case-generator/backend/venv/bin/uvicorn app.main:app --host 0.0.0.0 --port 8000 --workers 4
directory=/var/www/ai-test-case-generator/backend
user=www-data
autostart=true
autorestart=true
redirect_stderr=true
stdout_logfile=/var/log/supervisor/ai-test-backend.log
```

管理服务:

```bash
sudo supervisorctl reread
sudo supervisorctl update
sudo supervisorctl start ai-test-backend
sudo supervisorctl status
```

## 数据库管理

### 备份数据库

```bash
# 手动备份
pg_dump -U aitest -h localhost ai_test_case_generator > backup_$(date +%Y%m%d_%H%M%S).sql

# 定时备份脚本
sudo vim /usr/local/bin/backup-db.sh
```

备份脚本内容:

```bash
#!/bin/bash
BACKUP_DIR="/var/backups/postgresql"
DATE=$(date +%Y%m%d_%H%M%S)
mkdir -p $BACKUP_DIR
pg_dump -U aitest -h localhost ai_test_case_generator | gzip > $BACKUP_DIR/backup_$DATE.sql.gz
# 保留最近7天的备份
find $BACKUP_DIR -name "backup_*.sql.gz" -mtime +7 -delete
```

设置定时任务:

```bash
sudo chmod +x /usr/local/bin/backup-db.sh
sudo crontab -e

# 每天凌晨2点备份
0 2 * * * /usr/local/bin/backup-db.sh
```

### 恢复数据库

```bash
# 从备份恢复
gunzip < backup_20240101_020000.sql.gz | psql -U aitest -h localhost ai_test_case_generator
```

### 数据库迁移

```bash
cd /var/www/ai-test-case-generator/backend
source venv/bin/activate

# 查看当前版本
alembic current

# 升级到最新版本
alembic upgrade head

# 回滚一个版本
alembic downgrade -1
```

## 监控告警

### 1. 系统监控

安装监控工具:

```bash
# 安装htop
sudo apt install -y htop

# 安装iotop
sudo apt install -y iotop

# 安装nethogs
sudo apt install -y nethogs
```

### 2. 应用监控

创建监控脚本:

```bash
sudo vim /usr/local/bin/monitor-app.sh
```

内容:

```bash
#!/bin/bash

# 检查后端服务
if ! systemctl is-active --quiet ai-test-backend; then
    echo "Backend service is down!" | mail -s "Alert: Backend Down" admin@example.com
    systemctl restart ai-test-backend
fi

# 检查Nginx
if ! systemctl is-active --quiet nginx; then
    echo "Nginx is down!" | mail -s "Alert: Nginx Down" admin@example.com
    systemctl restart nginx
fi

# 检查PostgreSQL
if ! systemctl is-active --quiet postgresql; then
    echo "PostgreSQL is down!" | mail -s "Alert: PostgreSQL Down" admin@example.com
    systemctl restart postgresql
fi

# 检查Redis
if ! systemctl is-active --quiet redis-server; then
    echo "Redis is down!" | mail -s "Alert: Redis Down" admin@example.com
    systemctl restart redis-server
fi

# 检查磁盘空间
DISK_USAGE=$(df -h / | awk 'NR==2 {print $5}' | sed 's/%//')
if [ $DISK_USAGE -gt 80 ]; then
    echo "Disk usage is above 80%: ${DISK_USAGE}%" | mail -s "Alert: High Disk Usage" admin@example.com
fi

# 检查内存使用
MEM_USAGE=$(free | grep Mem | awk '{print int($3/$2 * 100)}')
if [ $MEM_USAGE -gt 90 ]; then
    echo "Memory usage is above 90%: ${MEM_USAGE}%" | mail -s "Alert: High Memory Usage" admin@example.com
fi
```

设置定时检查:

```bash
sudo chmod +x /usr/local/bin/monitor-app.sh
sudo crontab -e

# 每5分钟检查一次
*/5 * * * * /usr/local/bin/monitor-app.sh
```

### 3. 日志监控

配置日志轮转:

```bash
sudo vim /etc/logrotate.d/ai-test-case-generator
```

内容:

```
/var/log/ai-test-backend/*.log {
    daily
    rotate 7
    compress
    delaycompress
    notifempty
    create 0640 www-data www-data
    sharedscripts
    postrotate
        systemctl reload ai-test-backend > /dev/null 2>&1 || true
    endscript
}
```

## 备份恢复

### 完整备份脚本

```bash
sudo vim /usr/local/bin/full-backup.sh
```

内容:

```bash
#!/bin/bash
BACKUP_DIR="/var/backups/ai-test-case-generator"
DATE=$(date +%Y%m%d_%H%M%S)
mkdir -p $BACKUP_DIR/$DATE

# 备份数据库
pg_dump -U aitest -h localhost ai_test_case_generator | gzip > $BACKUP_DIR/$DATE/database.sql.gz

# 备份Redis
redis-cli --rdb $BACKUP_DIR/$DATE/redis.rdb

# 备份上传文件
tar -czf $BACKUP_DIR/$DATE/uploads.tar.gz /var/www/ai-test-case-generator/backend/uploads

# 备份知识库
tar -czf $BACKUP_DIR/$DATE/knowledge_base.tar.gz /var/www/ai-test-case-generator/backend/knowledge_base

# 备份配置文件
tar -czf $BACKUP_DIR/$DATE/configs.tar.gz /var/www/ai-test-case-generator/backend/.env /etc/nginx/sites-available/ai-test-case-generator

# 删除30天前的备份
find $BACKUP_DIR -type d -mtime +30 -exec rm -rf {} +

echo "Backup completed: $BACKUP_DIR/$DATE"
```

### 恢复脚本

```bash
sudo vim /usr/local/bin/restore-backup.sh
```

内容:

```bash
#!/bin/bash
if [ -z "$1" ]; then
    echo "Usage: $0 <backup_date>"
    exit 1
fi

BACKUP_DIR="/var/backups/ai-test-case-generator/$1"

if [ ! -d "$BACKUP_DIR" ]; then
    echo "Backup directory not found: $BACKUP_DIR"
    exit 1
fi

# 停止服务
systemctl stop ai-test-backend

# 恢复数据库
gunzip < $BACKUP_DIR/database.sql.gz | psql -U aitest -h localhost ai_test_case_generator

# 恢复上传文件
tar -xzf $BACKUP_DIR/uploads.tar.gz -C /

# 恢复知识库
tar -xzf $BACKUP_DIR/knowledge_base.tar.gz -C /

# 启动服务
systemctl start ai-test-backend

echo "Restore completed from: $BACKUP_DIR"
```

## 性能优化

### 1. PostgreSQL优化

编辑配置文件:

```bash
sudo vim /etc/postgresql/14/main/postgresql.conf
```

优化参数:

```ini
# 内存配置 (4GB服务器)
shared_buffers = 1GB
effective_cache_size = 3GB
maintenance_work_mem = 256MB
work_mem = 16MB

# 连接配置
max_connections = 100

# 查询优化
random_page_cost = 1.1
effective_io_concurrency = 200

# 日志配置
log_min_duration_statement = 1000
```

重启PostgreSQL:

```bash
sudo systemctl restart postgresql
```

### 2. Redis优化

编辑配置文件:

```bash
sudo vim /etc/redis/redis.conf
```

优化参数:

```ini
# 内存限制
maxmemory 512mb
maxmemory-policy allkeys-lru

# 持久化
save 900 1
save 300 10
save 60 10000

# 性能优化
tcp-backlog 511
timeout 300
```

重启Redis:

```bash
sudo systemctl restart redis-server
```

### 3. Nginx优化

编辑配置文件:

```bash
sudo vim /etc/nginx/nginx.conf
```

优化参数:

```nginx
worker_processes auto;
worker_connections 1024;

# 开启gzip压缩
gzip on;
gzip_vary on;
gzip_min_length 1024;
gzip_types text/plain text/css text/xml text/javascript application/json application/javascript application/xml+rss;

# 缓存配置
proxy_cache_path /var/cache/nginx levels=1:2 keys_zone=my_cache:10m max_size=1g inactive=60m;
```

### 4. 应用优化

增加Worker数量:

```bash
# 编辑服务文件
sudo vim /etc/systemd/system/ai-test-backend.service

# 修改ExecStart行
ExecStart=/var/www/ai-test-case-generator/backend/venv/bin/uvicorn app.main:app --host 0.0.0.0 --port 8000 --workers 8

# 重启服务
sudo systemctl daemon-reload
sudo systemctl restart ai-test-backend
```

## 故障排查

### 常见问题

#### 1. 后端服务无法启动

检查日志:

```bash
sudo journalctl -u ai-test-backend -n 100
```

常见原因:
- 端口被占用
- 数据库连接失败
- 环境变量配置错误
- Python依赖缺失

#### 2. 数据库连接失败

检查PostgreSQL状态:

```bash
sudo systemctl status postgresql
```

测试连接:

```bash
psql -U aitest -h localhost -d ai_test_case_generator
```

#### 3. Redis连接失败

检查Redis状态:

```bash
sudo systemctl status redis-server
redis-cli ping
```

#### 4. Nginx 502错误

检查后端服务:

```bash
sudo systemctl status ai-test-backend
curl http://localhost:8000/health
```

检查Nginx配置:

```bash
sudo nginx -t
```

#### 5. 磁盘空间不足

查看磁盘使用:

```bash
df -h
du -sh /var/* | sort -h
```

清理日志:

```bash
sudo journalctl --vacuum-time=7d
sudo find /var/log -name "*.log" -mtime +30 -delete
```

### 日志查看

```bash
# 后端日志
sudo journalctl -u ai-test-backend -f

# Nginx访问日志
sudo tail -f /var/log/nginx/access.log

# Nginx错误日志
sudo tail -f /var/log/nginx/error.log

# PostgreSQL日志
sudo tail -f /var/log/postgresql/postgresql-14-main.log

# Redis日志
sudo tail -f /var/log/redis/redis-server.log
```

## 安全加固

### 1. 防火墙配置

```bash
# 安装UFW
sudo apt install -y ufw

# 允许SSH
sudo ufw allow 22/tcp

# 允许HTTP/HTTPS
sudo ufw allow 80/tcp
sudo ufw allow 443/tcp

# 启用防火墙
sudo ufw enable

# 查看状态
sudo ufw status
```

### 2. 配置SSL/TLS

使用Let's Encrypt:

```bash
sudo certbot --nginx -d your-domain.com
```

### 3. 数据库安全

```bash
# 修改PostgreSQL密码
sudo -u postgres psql
ALTER USER aitest WITH PASSWORD 'new_secure_password';

# 限制远程访问
sudo vim /etc/postgresql/14/main/pg_hba.conf
# 只允许本地连接
host    all             all             127.0.0.1/32            md5
```

### 4. Redis安全

```bash
sudo vim /etc/redis/redis.conf

# 设置密码
requirepass your_redis_password

# 禁用危险命令
rename-command FLUSHDB ""
rename-command FLUSHALL ""
rename-command CONFIG ""
```

### 5. 应用安全

- 定期更新依赖包
- 使用强密码
- 启用HTTPS
- 配置CORS
- 实施访问控制
- 定期备份数据

---

更多信息请参考[用户指南](./用户指南.md)和[开发者文档](./开发者文档.md)。
