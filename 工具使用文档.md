# AI测试用例生成系统 - 工具使用文档

## 目录

- [知识库工具](#知识库工具)
- [脚本工具](#脚本工具)
- [模板工具](#模板工具)
- [Agent配置工具](#agent配置工具)
- [导出工具](#导出工具)
- [命令行工具](#命令行工具)

## 知识库工具

知识库是系统的重要组成部分，用于存储历史用例、缺陷记录、业务规则等信息，辅助AI生成更准确的测试用例。

### 知识库类型

系统支持以下类型的知识库：

| 类型 | 说明 | 用途 |
|------|------|------|
| 历史用例库 (case) | 存储历史测试用例 | 参考类似功能的用例设计 |
| 缺陷库 (defect) | 存储历史缺陷记录 | 识别高风险场景 |
| 业务规则库 (rule) | 存储业务规则文档 | 理解业务逻辑和约束 |
| 接口文档库 (api) | 存储API接口文档 | 获取接口定义和参数 |

### 上传知识库文档

#### 支持的文件格式

- **Word文档**: .doc, .docx
- **Excel表格**: .xls, .xlsx
- **PDF文档**: .pdf
- **Markdown文档**: .md
- **纯文本**: .txt

**注意**：
- 推荐使用新版格式（.docx, .xlsx）以获得最佳兼容性
- 旧版 .doc 格式支持有限，建议转换为 .docx
- 旧版 .xls 格式完全支持

#### 上传步骤

1. 进入"知识库管理"页面
2. 点击"上传文档"按钮
3. 选择文档类型
4. 拖拽文件或点击选择文件
5. 填写文档名称和描述
6. 添加标签（可选）
7. 点击"确认上传"

#### 上传示例

**上传历史用例文档**:
- 文档类型: 历史用例库 (case)
- 文档名称: 用户管理模块测试用例
- 标签: 用户管理, 登录, 注册
- 描述: 包含用户登录、注册、密码找回等功能的测试用例

**上传缺陷记录**:
- 文档类型: 缺陷库 (defect)
- 文档名称: 2024年Q1缺陷汇总
- 标签: 登录, 支付, 性能
- 描述: 第一季度发现的所有缺陷记录

### 管理知识库

#### 查看文档列表

知识库列表显示所有已上传的文档，支持以下操作：

- **搜索**: 输入关键词搜索文档
- **筛选**: 按类型、标签筛选
- **排序**: 按上传时间、名称排序
- **预览**: 点击文档名称查看详情

#### 编辑文档信息

1. 在文档列表中找到要编辑的文档
2. 点击"编辑"按钮
3. 修改文档名称、描述、标签
4. 点击"保存"

#### 删除文档

1. 在文档列表中找到要删除的文档
2. 点击"删除"按钮
3. 确认删除操作

**注意**: 删除操作不可恢复，请谨慎操作。

### 使用知识库

在生成测试用例时，可以关联相关的知识库文档：

1. 在需求输入页面，点击"关联知识库"
2. 选择相关的知识库文档
3. 系统会在生成过程中参考这些文档
4. 生成的用例会更贴合历史经验和业务规则

#### 最佳实践

- **及时更新**: 定期上传新的用例和缺陷记录
- **分类清晰**: 使用标签对文档进行分类
- **描述详细**: 添加详细的文档描述，便于搜索
- **质量优先**: 上传高质量的文档，避免错误信息
- **定期清理**: 删除过时的文档

### 知识库检索

系统支持两种检索方式：

#### 1. 关键词检索

基于文档内容的全文搜索：

- 输入关键词
- 系统在文档标题、描述、内容中搜索
- 返回匹配的文档列表

#### 2. 语义检索

基于向量相似度的智能检索：

- 输入自然语言描述
- 系统理解语义并查找相关文档
- 返回最相关的文档

**示例**:
- 关键词检索: "登录 密码"
- 语义检索: "用户使用错误密码登录的测试场景"

## 脚本工具

Python脚本用于生成测试数据、执行数据库操作、调用API等任务。

### 预置脚本

系统预置了常用的数据生成脚本：

#### 1. generate_phone_number

生成随机手机号

```python
import random

def generate_phone_number():
    """生成随机手机号"""
    prefix = ['130', '131', '132', '133', '134', '135', '136', '137', '138', '139',
              '150', '151', '152', '153', '155', '156', '157', '158', '159',
              '180', '181', '182', '183', '184', '185', '186', '187', '188', '189']
    return random.choice(prefix) + ''.join([str(random.randint(0, 9)) for _ in range(8)])
```

**使用方式**:
- 在用例中使用: `{{script:generate_phone_number}}`
- 生成结果: `13812345678`

#### 2. generate_id_card

生成随机身份证号

```python
import random
from datetime import datetime, timedelta

def generate_id_card():
    """生成随机身份证号"""
    # 地区码
    area_code = '110101'
    
    # 出生日期 (18-60岁)
    today = datetime.now()
    birth_date = today - timedelta(days=random.randint(18*365, 60*365))
    birth_str = birth_date.strftime('%Y%m%d')
    
    # 顺序码
    sequence = str(random.randint(100, 999))
    
    # 前17位
    id_17 = area_code + birth_str + sequence
    
    # 计算校验码
    weights = [7, 9, 10, 5, 8, 4, 2, 1, 6, 3, 7, 9, 10, 5, 8, 4, 2]
    check_codes = ['1', '0', 'X', '9', '8', '7', '6', '5', '4', '3', '2']
    sum_val = sum(int(id_17[i]) * weights[i] for i in range(17))
    check_code = check_codes[sum_val % 11]
    
    return id_17 + check_code
```

#### 3. generate_email

生成随机邮箱地址

```python
import random
import string

def generate_email():
    """生成随机邮箱"""
    username = ''.join(random.choices(string.ascii_lowercase, k=8))
    domains = ['test.com', 'example.com', 'demo.com']
    return f"{username}@{random.choice(domains)}"
```

#### 4. get_timestamp

获取当前时间戳

```python
import time

def get_timestamp():
    """获取当前时间戳（毫秒）"""
    return int(time.time() * 1000)
```

#### 5. md5_encrypt

MD5加密

```python
import hashlib

def md5_encrypt(text):
    """MD5加密"""
    return hashlib.md5(text.encode()).hexdigest()
```

#### 6. generate_random_string

生成随机字符串

```python
import random
import string

def generate_random_string(length=10, chars=None):
    """生成随机字符串"""
    if chars is None:
        chars = string.ascii_letters + string.digits
    return ''.join(random.choices(chars, k=length))
```

### 创建自定义脚本

#### 步骤

1. 进入"脚本管理"页面
2. 点击"新建脚本"按钮
3. 填写脚本信息
4. 编写Python代码
5. 测试运行
6. 保存脚本

#### 脚本编写规范

**基本结构**:

```python
def my_function(param1, param2):
    """
    函数说明
    
    Args:
        param1: 参数1说明
        param2: 参数2说明
    
    Returns:
        返回值说明
    """
    # 实现逻辑
    result = param1 + param2
    return result
```

**注意事项**:

- 函数名使用小写字母和下划线
- 添加详细的文档字符串
- 处理异常情况
- 返回明确的结果
- 避免使用全局变量

#### 示例：生成测试用户数据

```python
import random
from datetime import datetime, timedelta

def generate_test_user():
    """
    生成测试用户数据
    
    Returns:
        dict: 包含用户信息的字典
    """
    # 生成用户名
    username = f"test_user_{random.randint(1000, 9999)}"
    
    # 生成邮箱
    email = f"{username}@test.com"
    
    # 生成手机号
    phone = generate_phone_number()
    
    # 生成年龄
    age = random.randint(18, 60)
    
    # 生成注册时间
    register_date = datetime.now() - timedelta(days=random.randint(1, 365))
    
    return {
        "username": username,
        "email": email,
        "phone": phone,
        "age": age,
        "register_date": register_date.strftime("%Y-%m-%d %H:%M:%S")
    }

def generate_phone_number():
    """生成随机手机号"""
    prefix = ['130', '131', '132', '133', '134', '135', '136', '137', '138', '139']
    return random.choice(prefix) + ''.join([str(random.randint(0, 9)) for _ in range(8)])
```

### 测试脚本

在保存脚本之前，建议先测试运行：

1. 点击"测试运行"按钮
2. 输入测试参数（如果需要）
3. 查看输出结果
4. 检查是否有错误

**测试示例**:

```python
# 测试 generate_test_user 函数
result = generate_test_user()
print(result)

# 预期输出:
# {
#     "username": "test_user_1234",
#     "email": "test_user_1234@test.com",
#     "phone": "13812345678",
#     "age": 25,
#     "register_date": "2023-06-15 10:30:00"
# }
```

### 使用脚本

#### 在用例中使用

在测试用例的数据字段中使用脚本标记：

```json
{
  "test_data": {
    "username": "{{script:generate_test_user.username}}",
    "phone": "{{script:generate_phone_number}}",
    "email": "{{script:generate_email}}"
  }
}
```

系统会自动执行脚本并替换为生成的数据。

#### 通过API调用

```python
import requests

response = requests.post(
    'http://localhost:8000/scripts/1/execute',
    json={
        "args": [],
        "kwargs": {}
    }
)
result = response.json()
print(result['data']['result'])
```

### 脚本安全

系统对脚本执行进行了安全限制：

- **沙箱环境**: 脚本在隔离环境中执行
- **超时限制**: 执行时间不超过30秒
- **资源限制**: 限制内存和CPU使用
- **禁止操作**: 禁止访问文件系统和网络（除非明确允许）
- **日志记录**: 所有脚本执行都有日志记录

## 模板工具

用例模板定义了测试用例的结构和格式，确保生成的用例符合团队规范。

### 预置模板

系统预置了三种基本模板：

#### 1. UI测试模板

```json
{
  "name": "UI测试模板",
  "test_type": "ui",
  "fields": [
    {"name": "用例ID", "type": "string", "required": true},
    {"name": "用例标题", "type": "string", "required": true},
    {"name": "测试类型", "type": "string", "default": "UI测试"},
    {"name": "优先级", "type": "enum", "options": ["P0", "P1", "P2", "P3"]},
    {"name": "前置条件", "type": "text"},
    {"name": "测试步骤", "type": "array", "item_type": "step"},
    {"name": "测试数据", "type": "object"},
    {"name": "预期结果", "type": "text"},
    {"name": "后置条件", "type": "text"}
  ]
}
```

#### 2. 接口测试模板

```json
{
  "name": "接口测试模板",
  "test_type": "api",
  "fields": [
    {"name": "用例ID", "type": "string", "required": true},
    {"name": "接口名称", "type": "string", "required": true},
    {"name": "请求方法", "type": "enum", "options": ["GET", "POST", "PUT", "DELETE"]},
    {"name": "请求URL", "type": "string"},
    {"name": "请求头", "type": "object"},
    {"name": "请求体", "type": "object"},
    {"name": "断言配置", "type": "array"},
    {"name": "前置脚本", "type": "text"},
    {"name": "后置脚本", "type": "text"}
  ]
}
```

#### 3. 白盒测试模板

```json
{
  "name": "白盒测试模板",
  "test_type": "unit",
  "fields": [
    {"name": "测试函数名", "type": "string", "required": true},
    {"name": "测试目标", "type": "string"},
    {"name": "Mock配置", "type": "array"},
    {"name": "输入参数", "type": "object"},
    {"name": "预期输出", "type": "any"},
    {"name": "断言语句", "type": "array"}
  ]
}
```

### 创建自定义模板

#### 步骤

1. 进入"模板管理"页面
2. 点击"新建模板"按钮
3. 选择测试类型
4. 定义模板字段
5. 设置默认值和验证规则
6. 保存模板

#### 字段类型

| 类型 | 说明 | 示例 |
|------|------|------|
| string | 字符串 | "用户登录" |
| text | 多行文本 | "详细描述..." |
| number | 数字 | 123 |
| boolean | 布尔值 | true/false |
| enum | 枚举 | ["P0", "P1", "P2"] |
| array | 数组 | [1, 2, 3] |
| object | 对象 | {"key": "value"} |
| any | 任意类型 | - |

#### 示例：创建性能测试模板

```json
{
  "name": "性能测试模板",
  "test_type": "performance",
  "fields": [
    {
      "name": "用例ID",
      "type": "string",
      "required": true
    },
    {
      "name": "测试场景",
      "type": "string",
      "required": true
    },
    {
      "name": "并发用户数",
      "type": "number",
      "default": 100
    },
    {
      "name": "持续时间",
      "type": "number",
      "default": 300,
      "unit": "秒"
    },
    {
      "name": "性能指标",
      "type": "object",
      "properties": {
        "响应时间": {"type": "number", "unit": "ms"},
        "吞吐量": {"type": "number", "unit": "req/s"},
        "错误率": {"type": "number", "unit": "%"}
      }
    },
    {
      "name": "测试数据",
      "type": "array",
      "item_type": "object"
    }
  ]
}
```

### 使用模板

在生成测试用例时应用模板：

1. 在用例生成页面，点击"应用模板"
2. 选择合适的模板
3. AI会按照模板格式生成用例
4. 模板字段会自动映射到用例

### 导入导出模板

#### 导出模板

1. 在模板列表中选择要导出的模板
2. 点击"导出"按钮
3. 选择导出格式（JSON/Excel）
4. 下载模板文件

#### 导入模板

1. 点击"导入模板"按钮
2. 选择模板文件
3. 系统自动解析并创建模板
4. 确认导入

## Agent配置工具

Agent配置工具用于自定义AI Agent的行为，包括模型选择、提示词编辑、参数调整等。

### 配置Agent

#### 1. 选择AI模型

支持的模型提供商：

- **OpenAI**: GPT-4, GPT-3.5-turbo, GPT-4-turbo
- **Anthropic**: Claude-3-opus, Claude-3-sonnet, Claude-2
- **本地模型**: Ollama, LM Studio

**选择建议**:
- GPT-4: 质量最高，速度较慢，成本较高
- GPT-3.5-turbo: 速度快，成本低，质量中等
- Claude-3: 质量高，上下文长，适合复杂需求

#### 2. 调整模型参数

**Temperature (温度)**:
- 范围: 0-2
- 说明: 控制输出的随机性
- 建议值:
  - 0.3-0.5: 需要准确性和一致性
  - 0.7-0.9: 需要创造性和多样性
  - 1.0+: 需要高度创造性

**Max Tokens (最大令牌数)**:
- 范围: 100-4000
- 说明: 控制输出的最大长度
- 建议值:
  - 需求分析: 2000
  - 场景生成: 2000
  - 用例生成: 3000
  - 代码生成: 4000

**Top P (核采样)**:
- 范围: 0-1
- 说明: 控制采样的概率阈值
- 建议值: 0.9-1.0

#### 3. 编辑提示词

提示词是Agent的核心，决定了AI的行为和输出质量。

**提示词结构**:

```
角色定义：你是一个专业的XXX专家

任务描述：请XXX

输入数据：
{variable_name}

输出要求：
1. 格式：JSON
2. 内容：包含XXX
3. 注意事项：XXX

示例：
{example}
```

**变量占位符**:

- `{requirement_text}`: 需求文本
- `{knowledge_base}`: 知识库内容
- `{test_type}`: 测试类型
- `{test_scenario}`: 测试场景
- `{test_case}`: 测试用例

**编辑步骤**:

1. 进入"Agent配置"页面
2. 选择要配置的Agent
3. 点击"编辑提示词"
4. 在编辑器中修改提示词
5. 点击"保存"
6. 测试Agent

#### 4. 关联知识库

为Agent关联相关的知识库：

1. 在Agent配置页面，找到"关联知识库"部分
2. 勾选要关联的知识库
3. 设置知识库权重（可选）
4. 保存配置

### 测试Agent配置

修改配置后，建议测试Agent：

1. 点击"测试Agent"按钮
2. 输入测试数据
3. 查看Agent输出
4. 确认配置是否符合预期

### 恢复默认配置

如果配置出现问题，可以恢复默认配置：

1. 点击"恢复默认"按钮
2. 确认恢复操作
3. Agent配置恢复到系统默认值

## 导出工具

导出工具用于将生成的测试用例和报告导出为各种格式。

### 支持的导出格式

#### 1. Excel格式

**特点**:
- 标准表格格式
- 易于编辑和导入测试管理工具
- 支持多个工作表

**适用场景**:
- 导入到Jira、TestRail等工具
- 团队评审和修改
- 数据分析和统计

#### 2. Word格式

**特点**:
- 详细的文档格式
- 包含完整的用例描述
- 支持图片和表格

**适用场景**:
- 正式文档归档
- 评审和审批
- 客户交付

#### 3. JSON格式

**特点**:
- 结构化数据
- 易于程序处理
- 支持嵌套结构

**适用场景**:
- API调用和集成
- 数据交换
- 自动化处理

#### 4. Markdown格式

**特点**:
- 纯文本格式
- 易于版本管理
- 支持代码高亮

**适用场景**:
- Git版本管理
- 在线文档
- 技术博客

#### 5. HTML格式

**特点**:
- 网页格式
- 支持样式和交互
- 易于分享

**适用场景**:
- 在线查看
- 邮件发送
- 网站发布

### 导出步骤

1. 在用例生成完成后，点击"导出"按钮
2. 选择导出内容：
   - ☑ 测试用例
   - ☑ 测试场景
   - ☑ 质量报告
   - ☐ Agent配置
3. 选择导出格式
4. 点击"导出"按钮
5. 浏览器自动下载文件

### 批量导出

如果需要导出多个项目的用例：

1. 在用例列表页面，选择要导出的用例
2. 点击"批量导出"按钮
3. 选择导出格式
4. 系统生成压缩包下载

## 命令行工具

系统提供了一些命令行工具用于管理和维护。

### 数据库工具

#### 初始化数据库

```bash
cd backend
source venv/bin/activate
alembic upgrade head
```

#### 创建迁移

```bash
alembic revision --autogenerate -m "描述"
```

#### 回滚迁移

```bash
alembic downgrade -1
```

### 验证工具

#### 验证数据库

```bash
python scripts/verify_db.py
```

#### 验证安全配置

```bash
python scripts/verify_security.py
```

#### 验证模型配置

```bash
python scripts/test_model_config.py
```

### 数据导入导出

#### 导出知识库

```bash
python scripts/export_knowledge_base.py --output knowledge_base_backup.json
```

#### 导入知识库

```bash
python scripts/import_knowledge_base.py --input knowledge_base_backup.json
```

### 清理工具

#### 清理过期会话

```bash
python scripts/clean_expired_sessions.py
```

#### 清理临时文件

```bash
python scripts/clean_temp_files.py
```

---

更多信息请参考[用户指南](./用户指南.md)、[开发者文档](./开发者文档.md)和[接口文档](./接口文档.md)。
