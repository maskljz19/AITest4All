# AI测试用例生成系统 - 接口文档

## 目录

- [接口概述](#接口概述)
- [认证方式](#认证方式)
- [通用说明](#通用说明)
- [用例生成接口](#用例生成接口)
- [知识库管理接口](#知识库管理接口)
- [脚本管理接口](#脚本管理接口)
- [模板管理接口](#模板管理接口)
- [Agent配置接口](#agent配置接口)
- [模型配置接口](#模型配置接口)
- [提示词管理接口](#提示词管理接口)
- [导出接口](#导出接口)
- [WebSocket接口](#websocket接口)
- [错误码说明](#错误码说明)

## 接口概述

### 基础信息

- **Base URL**: `http://localhost:8000`
- **协议**: HTTP/HTTPS
- **数据格式**: JSON
- **字符编码**: UTF-8

### 接口文档地址

- **Swagger UI**: http://localhost:8000/docs
- **ReDoc**: http://localhost:8000/redoc

## 认证方式

目前系统暂未实现认证机制，所有接口均可直接访问。

## 通用说明

### 请求格式

所有POST/PUT请求使用JSON格式：

```json
{
  "field1": "value1",
  "field2": "value2"
}
```

### 响应格式

成功响应：

```json
{
  "success": true,
  "data": {
    // 具体数据
  },
  "message": "操作成功"
}
```

错误响应：

```json
{
  "success": false,
  "data": null,
  "message": "错误信息",
  "code": 500
}
```

### 分页参数

支持分页的接口使用以下参数：

- `page`: 页码，从1开始
- `page_size`: 每页数量，默认20

分页响应：

```json
{
  "success": true,
  "data": {
    "items": [],
    "total": 100,
    "page": 1,
    "page_size": 20,
    "pages": 5
  }
}
```

## 用例生成接口

### 1. 需求分析

**接口**: `POST /generate/requirement`

**描述**: 分析需求文档，提取测试关键信息

**请求参数**:

```json
{
  "requirement_text": "用户登录功能需求描述",
  "test_type": "ui",
  "knowledge_base_ids": [1, 2, 3]
}
```

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| requirement_text | string | 是 | 需求文档文本 |
| test_type | string | 是 | 测试类型：ui/api/unit |
| knowledge_base_ids | array | 否 | 关联的知识库ID列表 |

**响应示例**:

```json
{
  "success": true,
  "data": {
    "功能点列表": [
      "用户名密码登录",
      "记住密码功能",
      "忘记密码功能"
    ],
    "业务规则": [
      "用户名长度6-20位",
      "密码必须包含字母和数字"
    ],
    "数据模型": {
      "User": {
        "username": "string",
        "password": "string"
      }
    },
    "测试重点": [
      "密码加密存储",
      "登录失败次数限制"
    ],
    "风险点": [
      "SQL注入风险",
      "暴力破解风险"
    ]
  }
}
```

### 2. 场景生成

**接口**: `POST /generate/scenario`

**描述**: 根据需求分析结果生成测试场景

**请求参数**:

```json
{
  "requirement_analysis": {
    "功能点列表": ["..."],
    "业务规则": ["..."]
  },
  "test_type": "ui"
}
```

**响应示例**:

```json
{
  "success": true,
  "data": {
    "scenarios": [
      {
        "id": "S001",
        "name": "用户登录-正常流程",
        "description": "用户使用正确的用户名和密码登录",
        "type": "正常场景",
        "priority": "P0",
        "preconditions": "用户已注册",
        "expected_result": "登录成功，跳转到首页"
      }
    ]
  }
}
```

### 3. 用例生成

**接口**: `POST /generate/case`

**描述**: 为测试场景生成详细的测试用例

**请求参数**:

```json
{
  "scenarios": [
    {
      "id": "S001",
      "name": "用户登录-正常流程"
    }
  ],
  "template_id": 1,
  "script_ids": [1, 2]
}
```

**响应示例**:

```json
{
  "success": true,
  "data": {
    "test_cases": [
      {
        "id": "TC001",
        "title": "用户登录-正常流程",
        "type": "UI测试",
        "priority": "P0",
        "preconditions": "用户已注册，账号为admin，密码为123456",
        "steps": [
          {
            "step": 1,
            "action": "打开登录页面",
            "data": "http://example.com/login",
            "expected": "页面正常显示"
          },
          {
            "step": 2,
            "action": "输入用户名",
            "data": "admin",
            "expected": "用户名输入框显示admin"
          }
        ],
        "test_data": {
          "username": "admin",
          "password": "123456"
        },
        "postconditions": "退出登录"
      }
    ]
  }
}
```

### 4. 代码生成

**接口**: `POST /generate/code`

**描述**: 根据测试用例生成自动化测试代码

**请求参数**:

```json
{
  "test_cases": [
    {
      "id": "TC001",
      "title": "用户登录-正常流程"
    }
  ],
  "tech_stack": "Pytest + Selenium"
}
```

**响应示例**:

```json
{
  "success": true,
  "data": {
    "files": {
      "test_login.py": "# 测试代码内容",
      "conftest.py": "# 配置文件内容",
      "requirements.txt": "pytest\nselenium"
    }
  }
}
```

### 5. 质量分析

**接口**: `POST /generate/quality`

**描述**: 分析测试用例质量并提供改进建议

**请求参数**:

```json
{
  "requirement_analysis": {},
  "scenarios": [],
  "test_cases": []
}
```

**响应示例**:

```json
{
  "success": true,
  "data": {
    "coverage": {
      "percentage": 85,
      "uncovered_features": ["忘记密码功能"]
    },
    "quality_issues": [
      {
        "type": "重复用例",
        "cases": ["TC001", "TC002"],
        "suggestion": "合并为一个用例"
      }
    ],
    "score": {
      "total": 85,
      "coverage": 90,
      "quality": 80
    }
  }
}
```

## 知识库管理接口

### 1. 上传知识库文档

**接口**: `POST /knowledge-base/upload`

**描述**: 上传知识库文档

**请求参数**: multipart/form-data

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| file | file | 是 | 文档文件 |
| name | string | 是 | 文档名称 |
| type | string | 是 | 类型：case/defect/rule/api |
| tags | string | 否 | 标签，逗号分隔 |

**响应示例**:

```json
{
  "success": true,
  "data": {
    "id": 1,
    "name": "历史用例文档",
    "type": "case",
    "file_path": "/uploads/kb_001.docx",
    "created_at": "2024-01-01T00:00:00Z"
  }
}
```

### 2. 获取知识库列表

**接口**: `GET /knowledge-base/`

**描述**: 获取知识库文档列表

**请求参数**:

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| type | string | 否 | 文档类型筛选 |
| keyword | string | 否 | 搜索关键词 |
| page | int | 否 | 页码 |
| page_size | int | 否 | 每页数量 |

**响应示例**:

```json
{
  "success": true,
  "data": {
    "items": [
      {
        "id": 1,
        "name": "历史用例文档",
        "type": "case",
        "file_path": "/uploads/kb_001.docx",
        "tags": ["登录", "用户管理"],
        "created_at": "2024-01-01T00:00:00Z"
      }
    ],
    "total": 10,
    "page": 1,
    "page_size": 20
  }
}
```

### 3. 获取知识库详情

**接口**: `GET /knowledge-base/{kb_id}`

**描述**: 获取知识库文档详情

**响应示例**:

```json
{
  "success": true,
  "data": {
    "id": 1,
    "name": "历史用例文档",
    "type": "case",
    "storage_type": "local",
    "file_path": "/uploads/kb_001.docx",
    "content": "文档内容...",
    "metadata": {
      "size": 1024,
      "format": "docx"
    },
    "tags": ["登录", "用户管理"],
    "created_at": "2024-01-01T00:00:00Z"
  }
}
```

### 4. 删除知识库文档

**接口**: `DELETE /knowledge-base/{kb_id}`

**描述**: 删除知识库文档

**响应示例**:

```json
{
  "success": true,
  "message": "删除成功"
}
```

## 脚本管理接口

### 1. 创建脚本

**接口**: `POST /scripts/`

**描述**: 创建Python脚本

**请求参数**:

```json
{
  "name": "generate_phone_number",
  "description": "生成随机手机号",
  "code": "import random\ndef generate_phone_number():\n    ...",
  "dependencies": ["random"]
}
```

**响应示例**:

```json
{
  "success": true,
  "data": {
    "id": 1,
    "name": "generate_phone_number",
    "description": "生成随机手机号",
    "created_at": "2024-01-01T00:00:00Z"
  }
}
```

### 2. 获取脚本列表

**接口**: `GET /scripts/`

**描述**: 获取脚本列表

**响应示例**:

```json
{
  "success": true,
  "data": {
    "items": [
      {
        "id": 1,
        "name": "generate_phone_number",
        "description": "生成随机手机号",
        "is_builtin": true,
        "created_at": "2024-01-01T00:00:00Z"
      }
    ]
  }
}
```

### 3. 获取脚本详情

**接口**: `GET /scripts/{script_id}`

**描述**: 获取脚本详情

**响应示例**:

```json
{
  "success": true,
  "data": {
    "id": 1,
    "name": "generate_phone_number",
    "description": "生成随机手机号",
    "code": "import random\ndef generate_phone_number():\n    ...",
    "dependencies": ["random"],
    "is_builtin": true,
    "created_at": "2024-01-01T00:00:00Z"
  }
}
```

### 4. 更新脚本

**接口**: `PUT /scripts/{script_id}`

**描述**: 更新脚本

**请求参数**:

```json
{
  "name": "generate_phone_number",
  "description": "生成随机手机号（更新）",
  "code": "import random\ndef generate_phone_number():\n    ..."
}
```

### 5. 删除脚本

**接口**: `DELETE /scripts/{script_id}`

**描述**: 删除脚本

### 6. 执行脚本

**接口**: `POST /scripts/{script_id}/execute`

**描述**: 执行脚本并返回结果

**请求参数**:

```json
{
  "args": [],
  "kwargs": {}
}
```

**响应示例**:

```json
{
  "success": true,
  "data": {
    "result": "13812345678",
    "execution_time": 0.05
  }
}
```

## 模板管理接口

### 1. 获取所有模板

**接口**: `GET /templates/`

**描述**: 获取用例模板列表

**响应示例**:

```json
{
  "success": true,
  "data": {
    "items": [
      {
        "id": 1,
        "name": "UI测试模板",
        "test_type": "ui",
        "is_builtin": true,
        "created_at": "2024-01-01T00:00:00Z"
      }
    ]
  }
}
```

### 2. 获取模板详情

**接口**: `GET /templates/{template_id}`

**描述**: 获取模板详情

**响应示例**:

```json
{
  "success": true,
  "data": {
    "id": 1,
    "name": "UI测试模板",
    "test_type": "ui",
    "template_structure": {
      "fields": [
        {"name": "用例ID", "type": "string"},
        {"name": "用例标题", "type": "string"},
        {"name": "测试步骤", "type": "array"}
      ]
    },
    "is_builtin": true
  }
}
```

### 3. 创建模板

**接口**: `POST /templates/`

**描述**: 创建用例模板

**请求参数**:

```json
{
  "name": "自定义UI模板",
  "test_type": "ui",
  "template_structure": {
    "fields": [...]
  }
}
```

### 4. 更新模板

**接口**: `PUT /templates/{template_id}`

**描述**: 更新模板

### 5. 删除模板

**接口**: `DELETE /templates/{template_id}`

**描述**: 删除模板

## Agent配置接口

### 1. 获取所有Agent配置

**接口**: `GET /agent-configs/`

**描述**: 获取所有Agent配置列表

**响应示例**:

```json
{
  "success": true,
  "data": {
    "items": [
      {
        "id": 1,
        "agent_type": "requirement",
        "agent_name": "需求分析Agent",
        "model_provider": "openai",
        "model_name": "gpt-4",
        "is_default": true
      }
    ]
  }
}
```

### 2. 获取特定Agent配置

**接口**: `GET /agent-configs/{config_id}`

**描述**: 获取特定Agent配置详情

**响应示例**:

```json
{
  "success": true,
  "data": {
    "id": 1,
    "agent_type": "requirement",
    "agent_name": "需求分析Agent",
    "model_provider": "openai",
    "model_name": "gpt-4",
    "prompt_template": "你是一个专业的测试需求分析专家...",
    "model_params": {
      "temperature": 0.7,
      "max_tokens": 2000
    },
    "knowledge_bases": [1, 2],
    "scripts": [1],
    "is_default": true
  }
}
```

### 3. 创建Agent配置

**接口**: `POST /agent-configs/`

**描述**: 创建新的Agent配置

**请求参数**:

```json
{
  "agent_type": "requirement",
  "agent_name": "自定义需求分析Agent",
  "model_provider": "openai",
  "model_name": "gpt-4",
  "prompt_template": "...",
  "model_params": {
    "temperature": 0.7,
    "max_tokens": 2000
  }
}
```

### 4. 更新Agent配置

**接口**: `PUT /agent-configs/{config_id}`

**描述**: 更新Agent配置

### 5. 删除Agent配置

**接口**: `DELETE /agent-configs/{config_id}`

**描述**: 删除Agent配置

## 模型配置接口

### 1. 获取当前模型配置

**接口**: `GET /model-config/`

**描述**: 获取当前的模型配置

**响应示例**:

```json
{
  "success": true,
  "data": {
    "default_provider": "openai",
    "default_model": "gpt-4",
    "default_temperature": 0.7,
    "default_max_tokens": 2000,
    "agents": {
      "requirement": {
        "model_provider": "openai",
        "model_name": "gpt-4"
      }
    }
  }
}
```

### 2. 获取可用的模型提供商

**接口**: `GET /model-config/providers`

**描述**: 获取所有可用的模型提供商

**响应示例**:

```json
{
  "success": true,
  "data": {
    "providers": [
      {
        "name": "openai",
        "models": ["gpt-4", "gpt-3.5-turbo", "gpt-4-turbo"]
      },
      {
        "name": "anthropic",
        "models": ["claude-3-opus", "claude-3-sonnet", "claude-2"]
      }
    ]
  }
}
```

### 3. 获取特定Agent的模型配置

**接口**: `GET /model-config/agent/{agent_type}`

**描述**: 获取特定Agent的模型配置

**响应示例**:

```json
{
  "success": true,
  "data": {
    "agent_type": "requirement",
    "model_provider": "openai",
    "model_name": "gpt-4",
    "temperature": 0.7,
    "max_tokens": 2000
  }
}
```

## 提示词管理接口

### 1. 获取所有Agent提示词

**接口**: `GET /prompts/`

**描述**: 获取所有Agent的提示词

**响应示例**:

```json
{
  "success": true,
  "data": {
    "prompts": {
      "requirement": "你是一个专业的测试需求分析专家...",
      "scenario": "你是一个测试场景设计专家...",
      "case": "你是一个测试用例编写专家..."
    }
  }
}
```

### 2. 获取特定Agent提示词

**接口**: `GET /prompts/{agent_type}`

**描述**: 获取特定Agent的提示词

**响应示例**:

```json
{
  "success": true,
  "data": {
    "agent_type": "requirement",
    "prompt": "你是一个专业的测试需求分析专家..."
  }
}
```

### 3. 更新Agent提示词

**接口**: `PUT /prompts/{agent_type}`

**描述**: 更新特定Agent的提示词

**请求参数**:

```json
{
  "prompt": "你是一个专业的测试需求分析专家（更新版）..."
}
```

### 4. 重新加载所有提示词

**接口**: `POST /prompts/reload`

**描述**: 从文件重新加载所有提示词

**响应示例**:

```json
{
  "success": true,
  "message": "提示词重新加载成功"
}
```

## 导出接口

### 1. 导出测试用例

**接口**: `POST /export/test-cases`

**描述**: 导出测试用例

**请求参数**:

```json
{
  "test_cases": [
    {"id": "TC001", "title": "..."}
  ],
  "format": "excel",
  "include_scenarios": true,
  "include_quality_report": false
}
```

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| test_cases | array | 是 | 测试用例列表 |
| format | string | 是 | 导出格式：excel/word/json/markdown/html |
| include_scenarios | boolean | 否 | 是否包含场景 |
| include_quality_report | boolean | 否 | 是否包含质量报告 |

**响应**: 文件下载

### 2. 导出测试报告

**接口**: `POST /export/report`

**描述**: 导出测试报告

**请求参数**:

```json
{
  "requirement_analysis": {},
  "scenarios": [],
  "test_cases": [],
  "quality_report": {},
  "format": "word"
}
```

**响应**: 文件下载

## WebSocket接口

### 实时生成接口

**接口**: `WS /ws/{session_id}`

**描述**: WebSocket实时生成接口，支持流式输出

**连接示例**:

```javascript
const ws = new WebSocket('ws://localhost:8000/ws/session_123');

ws.onopen = () => {
  // 发送请求
  ws.send(JSON.stringify({
    agent_type: 'requirement',
    input_data: {
      requirement_text: '用户登录功能'
    }
  }));
};

ws.onmessage = (event) => {
  const data = JSON.parse(event.data);
  
  if (data.type === 'chunk') {
    // 处理流式输出
    console.log(data.content);
  } else if (data.type === 'done') {
    // 生成完成
    console.log('完成');
  } else if (data.type === 'error') {
    // 错误处理
    console.error(data.message);
  }
};
```

**消息类型**:

1. **chunk**: 流式输出的内容片段
```json
{
  "type": "chunk",
  "content": "部分生成的内容"
}
```

2. **done**: 生成完成
```json
{
  "type": "done"
}
```

3. **error**: 错误信息
```json
{
  "type": "error",
  "message": "错误描述"
}
```

## 错误码说明

### HTTP状态码

| 状态码 | 说明 |
|--------|------|
| 200 | 请求成功 |
| 400 | 请求参数错误 |
| 401 | 未授权 |
| 403 | 禁止访问 |
| 404 | 资源不存在 |
| 500 | 服务器内部错误 |

### 业务错误码

| 错误码 | 说明 |
|--------|------|
| 1001 | 参数验证失败 |
| 1002 | 资源不存在 |
| 1003 | 资源已存在 |
| 2001 | 数据库操作失败 |
| 2002 | Redis操作失败 |
| 3001 | LLM调用失败 |
| 3002 | Agent执行失败 |
| 4001 | 文件上传失败 |
| 4002 | 文件解析失败 |
| 5001 | 脚本执行失败 |
| 5002 | 脚本超时 |

### 错误响应示例

```json
{
  "success": false,
  "data": null,
  "message": "参数验证失败：requirement_text不能为空",
  "code": 1001
}
```

## 接口调用示例

### Python示例

```python
import requests

# 需求分析
response = requests.post(
    'http://localhost:8000/generate/requirement',
    json={
        'requirement_text': '用户登录功能',
        'test_type': 'ui'
    }
)
result = response.json()
print(result)

# 上传知识库
files = {'file': open('document.docx', 'rb')}
data = {
    'name': '历史用例文档',
    'type': 'case'
}
response = requests.post(
    'http://localhost:8000/knowledge-base/upload',
    files=files,
    data=data
)
```

### JavaScript示例

```javascript
// 需求分析
fetch('http://localhost:8000/generate/requirement', {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json'
  },
  body: JSON.stringify({
    requirement_text: '用户登录功能',
    test_type: 'ui'
  })
})
.then(response => response.json())
.then(data => console.log(data));

// 上传知识库
const formData = new FormData();
formData.append('file', fileInput.files[0]);
formData.append('name', '历史用例文档');
formData.append('type', 'case');

fetch('http://localhost:8000/knowledge-base/upload', {
  method: 'POST',
  body: formData
})
.then(response => response.json())
.then(data => console.log(data));
```

### cURL示例

```bash
# 需求分析
curl -X POST http://localhost:8000/generate/requirement \
  -H "Content-Type: application/json" \
  -d '{
    "requirement_text": "用户登录功能",
    "test_type": "ui"
  }'

# 上传知识库
curl -X POST http://localhost:8000/knowledge-base/upload \
  -F "file=@document.docx" \
  -F "name=历史用例文档" \
  -F "type=case"

# 获取知识库列表
curl -X GET "http://localhost:8000/knowledge-base/?page=1&page_size=20"
```

## 接口测试

### 使用Postman测试

1. 导入API文档：访问 http://localhost:8000/docs，导出OpenAPI规范
2. 在Postman中导入OpenAPI文件
3. 配置环境变量：`base_url = http://localhost:8000`
4. 测试各个接口

### 使用Swagger UI测试

1. 访问 http://localhost:8000/docs
2. 展开要测试的接口
3. 点击"Try it out"
4. 填写参数
5. 点击"Execute"查看结果

---

更多信息请参考[用户指南](./用户指南.md)和[开发者文档](./开发者文档.md)。
